<?php

namespace AppBundle\Repository;

use Doctrine\ORM\EntityRepository;
use Symfony\Component\Validator\Constraints\DateTime;

/**
 * CustomerRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class CustomerRepository extends EntityRepository
{

    public function searchByAll($data, $user)
    {
        $query = $this->createQueryBuilder('c')
            ->where("c.numberAccount LIKE '$data%'")
            ->andWhere("c.user = :user")
            ->setParameter('user', $user )
            ->getQuery()
            ->getResult();

        return $query;
    }

    public function sortsBy($alias)
    {
        $query = $this->createQueryBuilder('c')
            ->orderBy('c.'.$alias, 'ASC')
            ->getQuery()
            ->getResult();

        return $query;
    }

    public function findByMonthYear($monthsAt = null, $yearsAt = null, $monthTo = null, $yearsTo = null)
    {
        $monthsAt = ($monthsAt)? '0'.$monthsAt:date("n");
        $yearsAt = ($yearsAt)? $yearsAt:date("Y");
        $monthTo = ($monthTo)? '0'.$monthTo:date("n");
        $yearsTo = ($yearsTo)? '0'.$yearsTo:date("Y");

        $latestDayByMonth = cal_days_in_month(CAL_GREGORIAN, date("n"), date("y"));

        $dateAt   = new \DateTime($yearsAt."-".$monthsAt."-01"."00:00:00");
        $dateTo = new \DateTime($yearsTo."-".$monthTo."-".$latestDayByMonth."23:59:59");

        $query = $this->createQueryBuilder('c')
            ->andWhere('c.createdAt BETWEEN :dateAt AND :dateTo')
            ->setParameter('dateAt', $dateAt )
            ->setParameter('dateTo', $dateTo)
            ->orderBy('c.createdAt',' ASC')

        ;

        $result = $query->getQuery()->getResult();

        return $result;
    }

    public function findByLessMonth($months = null)
    {
//        1
//        12


        $dateAt   = new \DateTime($yearsAt."-".$monthsAt."-01"."00:00:00");
        $dateTo = new \DateTime("Y-n-".cal_days_in_month(CAL_GREGORIAN, date("n"), date("y"))."23:59:59");

        $query = $this->createQueryBuilder('c')
            ->andWhere('c.createdAt BETWEEN :dateAt AND :dateTo')
            ->setParameter('dateAt', $dateAt )
            ->setParameter('dateTo', $dateTo)
            ->orderBy('c.createdAt',' ASC')

        ;

        $result = $query->getQuery()->getResult();

        return $result;
    }
}
